---
- name: Timezone Verify
  hosts: all
  gather_facts: false

# US/Central
# Europe/Berlin

  tasks:
    - name: Gather package facts
      ansible.builtin.package_facts:

    - name: Gather service facts
      ansible.builtin.service_facts:

    - name: Verify tzdata package is installed
      ansible.builtin.assert:
        that:
          - "'tzdata' in ansible_facts.packages"

# TODO: Re-enable this after the next Debian stable release
#          - "'systemd-timesyncd' in ansible_facts.packages"

    - name: Read current time zone
      ansible.builtin.shell: cat /etc/timezone
      changed_when: false
      register: current_time_zone

    - name: Assert we have the correct Timezone
      ansible.builtin.assert:
        that: current_time_zone.stdout == 'Europe/Berlin'

    - name: Timesyncd config file should be managed by Ansible
      ansible.builtin.lineinfile:
        path: /etc/systemd/timesyncd.conf
        line: "## Ansible managed: Do NOT edit this file manually!"
        backup: no
      check_mode: yes
      register: conf
      failed_when: (conf is changed) or (conf is failed)

    - name: Timesyncd Service is running
      ansible.builtin.assert:
        that: "ansible_facts.services['systemd-timesyncd.service'].state == 'running'"

    - name: Timesyncd Service is enabled
      ansible.builtin.command:
        cmd: "systemctl is-enabled systemd-timesyncd.service"
      register: service
      changed_when: false
      failed_when: "service.stdout != 'enabled'"

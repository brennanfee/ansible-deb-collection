---
# vim: set ft=yaml.ansible:

- name: Check If Vagrant User Exists
  ansible.builtin.getent:
    database: passwd
    key: vagrant
    fail_key: false

- name: Add Vagrant user to the default groups
  become: true
  ansible.builtin.user:
    name: vagrant
    groups: "{{ item }}"
    append: true
  with_items:
    - audio
    - video
    - plugdev
    - netdev
    - sudo
    - _ssh
    - users
    - data-user
  when: ansible_facts.getent_passwd.vagrant != None

- name: Add Vagrant user to the Virtualbox Group
  become: true
  ansible.builtin.user:
    name: vagrant
    groups: vboxsf
    append: true
  when: ansible_facts.getent_passwd.vagrant != None
    and ansible_virtualization_type == "virtualbox"
    and ansible_virtualization_role == "guest"

- name: Setup Vagrant user for password-less sudo
  become: true
  ansible.builtin.template:
    src: etc-sudoers.d--vagrant.j2
    dest: /etc/sudoers.d/vagrant
    owner: root
    group: root
    mode: "0440"
    backup: true
  when: ansible_facts.getent_passwd.vagrant != None
